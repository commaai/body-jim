name: tests

on: [push, pull_request]

jobs:
  fetch-versions:
    runs-on: ubuntu-20.04
    steps:
        - id: filter-versions
          run: |
            API_RESPONSE=$(curl -s https://endoflife.date/api/python.json)

            # Filter versions based on EOL date and format output as JSON array
            FILTERED_VERSIONS=$(echo $API_RESPONSE | jq -c '[.[] | select(.eol > "'$(date +"%Y-%m-%d")'") | .cycle]')

            echo "versions=$FILTERED_VERSIONS" >> $GITHUB_OUTPUT
    outputs:
      versions: ${{ steps.filter-versions.outputs.versions }}

  test:
    runs-on: ubuntu-20.04
    needs: fetch-versions
    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ fromJson(needs.fetch-versions.outputs.versions) }}
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install package
      run: pip install -e .[dev]
    - name: Unit Tests
      run: |
        cd tests/; python -m unittest discover
  static_analysis:
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Install pre-commit
      run: pip install pre-commit
    - name: Static analysis
      run: |
        pre-commit run --all
